<?xml version="1.0" encoding="UTF-8"?>
<implementation>
    <functions>
        -- -------------------------------------------------------------------------------------------------------------------------
        -- Deus Ex Machina (II)
        -- https://github.com/toggledbits/DeusExMachina
        -- Original code and releases 1.x by Andy Lintner (beowulfe) Version 2.0 and beyond by Patrick Rigney (rigpapa/toggledbits).
        -- A big thanks to Andy for passing the torch so that this great plug-in can live on.
        -- -------------------------------------------------------------------------------------------------------------------------
        function startupDeusExMachinaII1()
            luup.log("DeusExMachinaII STARTUP!")
            demII = require("L_DeusExMachinaII1")
            deusStep = demII.deusStep
            demII.deusInit()
        end
    </functions>
    <startup>startupDeusExMachinaII1</startup>
    <actionList>
        <action>
            <serviceId>urn:upnp-org:serviceId:SwitchPower1</serviceId>
            <name>SetTarget</name>
            <run>
                local newTargetValue = lul_settings.newTargetValue or "0"
                luup.variable_set("urn:upnp-org:serviceId:SwitchPower1", "Target", newTargetValue, lul_device)
                if (newTargetValue == "1") then
                    demII.deusEnable()
                else
                    demII.deusDisable()
                end
            </run>
        </action>
        <action>
            <serviceId>urn:upnp-org:serviceId:SwitchPower1</serviceId>
            <name>GetTarget</name>
            <run>
                luup.variable_get("urn:upnp-org:serviceId:SwitchPower1", "Target", lul_device)
            </run>
        </action>
        <action>
            <serviceId>urn:upnp-org:serviceId:SwitchPower1</serviceId>
            <name>GetStatus</name>
            <run>
                luup.variable_get("urn:upnp-org:serviceId:SwitchPower1", "Status", lul_device)
            </run>
        </action>
        <action>
            <serviceId>urn:toggledbits-com:serviceId:DeusExMachinaII1</serviceId>
            <name>SetEnabled</name>
            <run>
                local newEnabledValue = lul_settings.NewEnabledValue or "0"
                luup.variable_set("urn:upnp-org:serviceId:SwitchPower1", "Target", newEnabledValue, lul_device)
                if (newEnabledValue == "1") then
                    demII.deusEnable()
                else
                    demII.deusDisable()
                end
            </run>
        </action>
        <action>
            <serviceId>urn:toggledbits-com:serviceId:DeusExMachinaII1</serviceId>
            <name>GetPluginVersion</name>
            <run>
                -- Ugly hack. Luup seems to only be able to return values from related state variables (see S_), so use a temp
                -- one to store the result we want to pass back. Blech. C'mon guys. Amateur hour. Add an extra return argument
                -- for a table of return values or something, please?
                luup.variable_set("urn:toggledbits-com:serviceId:DeusExMachinaII1", "TempStorage", demII.getVersion(), lul_device)
                return true
            </run>
        </action>
    </actionList>
</implementation>
